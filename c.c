#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/wait.h>
#include <linux/in.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <signal.h>

extern int errno;

int create_server(void) {
	int fd = -1;
	struct sockaddr_in saddr;

	memset(&saddr, 0, sizeof(struct sockaddr_in));
	saddr.sin_family = AF_INET;
	saddr.sin_port = htons(6001);

	fd = socket(AF_INET, SOCK_STREAM, 0);
	if (fd == -1)
		return fd;
	bind(fd, (struct sockaddr*)&saddr, sizeof(struct sockaddr_in));
	return fd;
}

void sighndl(int v) {
	while (0 < waitpid(-1, NULL, WNOHANG)) { printf("Collected ...\n"); }
}

void read_too_much(int client) {
	char eight_bytes[8];
	char char_read = 0;
	int just_read = 0;
	int i = 0;
	printf("eight_bytes = 0x%x\n", eight_bytes);
	printf("char_read = 0x%x\n", &char_read);
	printf("just_read = 0x%x\n", &just_read);
	printf("client = 0x%x\n", &client);
	printf("i = 0x%x\n", &i);

	memset(eight_bytes, sizeof(char)*4, 0);

	printf("read_too_much!\n");
	while ((0 < (just_read = read(client, &char_read, 1))) && char_read != '\n') {
		printf("read: %c\n", char_read);
		printf("just_read: %d\n", just_read);
		printf("eight_bytes[i]: %p\n", &(eight_bytes[i]));
		eight_bytes[i++] = char_read;
	}
	printf("(final)read: %c\n", char_read);
	printf("(final)just_read = %d\n", just_read);

	return;
}

void write_success(int client) {
	char *success = "s";
	int wrote = 0;
	if (0 > (wrote = write(client, success, strlen(success))))
	{
		printf("write() failed (%d): %s\n", wrote, strerror(errno));
	}
	return;
}

void server(int sock) {
	int client = 0;
	int child_pid = 0;

	if (-1 == listen(sock, 0)) {
		return;
	}

	for (;;) {
		client = accept(sock, NULL, NULL);
		if (0 == (child_pid = fork())) {
			close(sock);
			printf("accept client: %p\n", &client);
			printf("accept client: %d\n", client);
			read_too_much(client);
			printf("post-read client: %d\n", client);
			write_success(client);
			close(client);
			shutdown(client, SHUT_RDWR);
			printf("Shutting down client.\n");
			_exit(0);
		}
		close(client);
	}
}

void hijacked(void) {
	printf("hijacked!\n");
	while (1) {}
	return;
}

int main() {
	int fd = -1;

	printf("&hijacked: 0x%x\n", hijacked);

	signal(SIGCHLD, sighndl);

	fd = create_server();
	if (fd == -1) {
		printf("error: create_server() failed.\n");
		return 1;
	}
	server(fd);
	shutdown(fd, SHUT_RDWR);
	close(fd);
	return 0;
}
