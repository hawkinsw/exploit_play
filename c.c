#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <linux/in.h>
#include <string.h>

int create_server(void) {
	int fd = -1;
	struct sockaddr_in saddr;

	memset(&saddr, 0, sizeof(struct sockaddr_in));
	saddr.sin_family = AF_INET;
	saddr.sin_port = htons(6001);

	fd = socket(AF_INET, SOCK_STREAM, 0);
	if (fd == -1)
		return fd;
	bind(fd, (struct sockaddr*)&saddr, sizeof(struct sockaddr_in));
	return fd;
}

void read_too_much(int client) {
	char eight_bytes[8];
	char char_read = 0;
	int just_read = 0;
	int i = 0;

	printf("eight_bytes = 0x%x\n", eight_bytes);
	printf("char_read = 0x%x\n", &char_read);
	printf("just_read = 0x%x\n", &just_read);
	printf("client = 0x%x\n", &client);
	printf("i = 0x%x\n", &i);

	memset(eight_bytes, sizeof(char)*4, 0);

	printf("read_too_much!\n");
	while ((0 < (just_read = read(client, &char_read, 1))) && char_read != '\n') {
		printf("read: %c\n", char_read);
		printf("just_read: %d\n", just_read);
		eight_bytes[i++] = char_read;
	}
	printf("read: %c\n", char_read);
	printf("just_read = %d\n", just_read);
	return;
}

void server(int sock) {
	int client = 0;
	int child_pid = 0;

	if (-1 == listen(sock, 0)) {
		return;
	}

	for (;;) {
		client = accept(sock, NULL, NULL);
		if (0 == (child_pid = fork())) {
			read_too_much(client);
			shutdown(client, SHUT_RDWR);
			close(client);
			exit(0);
		}
	}
}

void hijacked(void) {
	printf("hijacked!\n");
	exit(0);
	return;
}

int main() {
	int fd = -1;

	printf("&hijacked: 0x%x\n", hijacked);

	fd = create_server();
	if (fd == -1) {
		printf("error: create_server() failed.\n");
		return 1;
	}
	server(fd);
	shutdown(fd, SHUT_RDWR);
	close(fd);
	return 0;
}
